{% load static %}
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>CPPN Services · Policies</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .svc-id { color:#6c757d; font-size:.82rem; }
    .badge-actor { background: var(--bs-primary-bg-subtle); color: var(--bs-primary-text); border: 1px solid var(--bs-primary-border-subtle); font-weight: 500; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h4 class="mb-0">CPPN Services · Policies</h4>
    <a href="{% url 'rbac_cppn' %}?id={{ diagram_id }}" class="btn btn-outline-secondary btn-sm">Back</a>
  </div>

  <div id="alertHolder" class="mb-2"></div>

  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:36%">Service</th>
              <th>Actors with invoke</th>
              <th style="width:12%" class="text-end">Edit</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="3" class="text-center py-4">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
  const API_URL = "{% url 'rbac_cppn_services_api' %}";

  function esc(s){return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
  function alertHtml(kind,msg){return `<div class="alert alert-${kind} alert-dismissible fade show" role="alert">${esc(msg)}<button class="btn-close" data-bs-dismiss="alert"></button></div>`;}

  // builder URL edit
  function buildEditUrl(row, diagramId){
    if (row.service_type === "atomic"){
      // /editor/policies/atomic/<atomic_id>/edit/?id=<diagram_id>
      return "{% url 'rbac_atomic_edit' 'ATOMIC_PLACEHOLDER' %}"
              .replace("ATOMIC_PLACEHOLDER", encodeURIComponent(row.service_id))
              + `?id=${encodeURIComponent(diagramId)}`;
    } else {
      // /editor/policies/cpps/<group_id>/edit/?id=<diagram_id>
      return "{% url 'rbac_cpps_edit' 'CPPS_PLACEHOLDER' %}"
              .replace("CPPS_PLACEHOLDER", encodeURIComponent(row.service_id))
              + `?id=${encodeURIComponent(diagramId)}`;
    }
  }

  function rowHtml(row, diagramId){
    const name = row.service_name || row.service_id;
    const chips = (row.actors_invoke||[]).map(a=>`<span class="badge badge-actor me-1 mb-1">${esc(a)}</span>`).join("") || '<span class="text-muted">—</span>';

    return `<tr>
      <td>
        <div class="fw-semibold">${esc(name)}</div>
        <div class="svc-id">${esc(row.service_id)} · <span class="text-capitalize">${esc(row.service_type)}</span></div>
      </td>
      <td>${chips}</td>
      <td class="text-end">
        <a class="btn btn-primary btn-sm" href="${buildEditUrl(row, diagramId)}">Edit</a>
      </td>
    </tr>`;
  }

  async function load(){
    const diagramId = "{{ diagram_id }}";
    const cppnId    = "{{ cppn_id }}";
    const tbody     = document.getElementById("tbody");
    const holder    = document.getElementById("alertHolder");

    const qs = new URLSearchParams({ diagram_id: diagramId, cppn_id: cppnId });
    const r  = await fetch(`${API_URL}?${qs.toString()}`);
    if (!r.ok){
      const t = await r.text().catch(()=> "");
      holder.innerHTML = alertHtml('danger', `API error (${r.status}) ${esc(t)}`);
      tbody.innerHTML  = `<tr><td colspan="3" class="text-center text-danger py-4">Errore nel caricamento</td></tr>`;
      return;
    }
    const data = await r.json();
    const rows = (data.results || []).map(x => rowHtml(x, diagramId)).join("");
    tbody.innerHTML = rows || `<tr><td colspan="3" class="text-center text-muted py-4">Nessun service nel CPPN</td></tr>`;
  }

  load();
</script>
</body>
</html>
