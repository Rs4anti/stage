{% load static %}
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Edit CPPS Policy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h4 class="mb-0">Edit CPPS Policy</h4>
    <a href="{% url 'rbac_cpps' %}?id={{ diagram_id }}" class="btn btn-outline-secondary btn-sm">Back</a>
  </div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Diagram ID</label>
          <input id="diagram_id" class="form-control" value="{{ diagram_id }}" readonly>
        </div>
        <div class="col-md-6">
          <label class="form-label">CPPS ID</label>
          <input id="cpps_id" class="form-control" value="{{ cpps_id }}" readonly>
        </div>
      </div>
    </div>
  </div>

  <form class="card">
    <div class="card-body">
      <div id="alertHolder" class="mb-2"></div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Owner</label>
          <input id="owner" class="form-control" readonly>
        </div>
        <div class="col-md-6">
          <label class="form-label">Activities in CPPS</label>
          <div id="servicesBox" class="form-control" style="height:auto; min-height:38px; overflow:auto;" readonly></div>
        </div>
      </div>

      <hr class="my-4">

      <div class="d-flex align-items-center justify-content-between">
        <h6 class="mb-0">Permissions</h6>
        <button type="button" class="btn btn-success btn-sm" id="addPermBtn">+ Add actor</button>
      </div>
      <div id="permsList" class="mt-3"></div>

      <div class="text-end mt-4">
        <button type="button" class="btn btn-primary" id="saveBtn" disabled>Save</button>
      </div>
    </div>
  </form>
</div>

<script>
  const API_GET_ONE = "{% url 'rbac_cpps_one' %}";
  const API_UPDATE  = "{% url 'rbac_cpps_update_permissions' %}";
  const API_ACTORS  = "{% url 'diagram_actors' %}";

  function esc(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }
  function alertHtml(kind,msg){ return `<div class="alert alert-${kind} alert-dismissible fade show" role="alert">${esc(msg)}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`; }
  function getCookie(name){ const v = `; ${document.cookie}`.split(`; ${name}=`); if (v.length===2) return v.pop().split(';').shift(); }

  async function fetchActors(diagramId){
    const r = await fetch(`${API_ACTORS}?diagram_id=${encodeURIComponent(diagramId)}`);
    if(!r.ok) throw new Error("Cannot load actors");
    const data = await r.json(); return data.actors || [];
  }

  function badge(code){ return `<span class="badge bg-light text-body-secondary border">${esc(code)}</span>`; }

  function readExtraActors(owner){
    return [...document.querySelectorAll(".perm-row select.perm-actor")]
      .filter(sel => !sel.disabled)
      .map(sel => (sel.value||"").trim())
      .filter(v => v && v !== owner)
      .filter((v,i,arr)=> arr.indexOf(v)===i);
  }

  function permissionRowHTML({rowId, actors, actor, readonly=false, ownerActor=null}){
    const options = actors.filter(a => a!==ownerActor).map(a => `<option value="${esc(a)}" ${a===actor?'selected':''}>${esc(a)}</option>`).join("");
    const selectActor = `
      <select class="form-select form-select-sm perm-actor" ${readonly?'disabled':'required'}>
        <option value="" ${actor?'':'selected'} disabled>— select actor —</option>
        ${options}
      </select>`;
    const removeBtn = readonly ? "" : `<button type="button" class="btn btn-danger btn-sm" data-remove="${rowId}" title="Revoke"><i class="bi bi-trash"></i></button>`;
    const actorField = readonly
      ? `<input class="form-control form-control-sm" value="${esc(actor)}" readonly>`
      : selectActor;
    return `
      <div class="row g-2 align-items-end mb-2 perm-row" data-row="${rowId}">
        <div class="col-md-11">
          <label class="form-label form-label-sm">Actor</label>
          ${actorField}
        </div>
        <div class="col-md-1 text-end">
          ${removeBtn}
        </div>
      </div>`;
  }

  document.addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-remove]");
    if(!btn) return;
    const row = btn.closest(".perm-row");
    if (row) row.remove();
  });

  document.addEventListener("change", (e)=>{
    if(!e.target.classList.contains("perm-actor")) return;
    const chosen = e.target.value;
    const owner = document.getElementById("owner").value.trim();
    const current = readExtraActors(owner);
    const dup = current.filter(a => a===chosen);
    if (dup.length > 1){
      e.target.value = "";
      e.target.closest(".perm-row").classList.add("is-invalid");
      setTimeout(()=> e.target.closest(".perm-row")?.classList.remove("is-invalid"), 1200);
    }
  });

  let ACTORS = [];
  async function load(){
    const diagram_id = document.getElementById("diagram_id").value;
    const cpps_id    = document.getElementById("cpps_id").value;
    const alertHolder = document.getElementById("alertHolder");
    const r = await fetch(`${API_GET_ONE}?diagram_id=${encodeURIComponent(diagram_id)}&cpps_id=${encodeURIComponent(cpps_id)}`);
    if(!r.ok){
      const txt = await r.text().catch(()=> "");
      alertHolder.innerHTML = alertHtml('danger', `Errore caricamento (${r.status}): ${esc(txt)}`);
      return;
    }
    const data = await r.json();
    document.getElementById("owner").value = data.owner || "";

    // compose services box (unique)
    const services = Array.from(new Set((data.permissions||[]).map(p => p.service).filter(Boolean))).sort();
    document.getElementById("servicesBox").innerHTML = services.length ? services.map(badge).join(" ") : '<span class="text-muted">—</span>';

    ACTORS = await fetchActors(diagram_id);

    const owner = data.owner || "";
    const permsList = document.getElementById("permsList");
    permsList.innerHTML = "";

    // owner row (readonly)
    permsList.insertAdjacentHTML("beforeend",
      permissionRowHTML({rowId: crypto.randomUUID(), actors: ACTORS, actor: owner, readonly:true, ownerActor: owner})
    );

    // extra rows (actors ≠ owner) - da permissions attuali deduciamo gli attori presenti
    const extraActors = Array.from(new Set((data.permissions||[])
                          .filter(p => p.actor && p.actor !== owner)
                          .map(p => p.actor)));

    for(const a of extraActors){
      permsList.insertAdjacentHTML("beforeend",
        permissionRowHTML({rowId: crypto.randomUUID(), actors: ACTORS, actor: a, readonly:false, ownerActor: owner})
      );
    }

    document.getElementById("saveBtn").disabled = false;

    // Add button
    document.getElementById("addPermBtn").addEventListener("click", ()=>{
      permsList.insertAdjacentHTML("beforeend",
        permissionRowHTML({rowId: crypto.randomUUID(), actors: ACTORS, actor: "", readonly:false, ownerActor: owner})
      );
    });
  }
  load();

  // SAVE
  document.getElementById("saveBtn").addEventListener("click", async (e)=>{
    e.preventDefault();
    const diagram_id = document.getElementById("diagram_id").value.trim();
    const cpps_id    = document.getElementById("cpps_id").value.trim();
    const owner      = document.getElementById("owner").value.trim();
    const extra = readExtraActors(owner);

    const r = await fetch(API_UPDATE, {
      method: "PUT",
      headers: {"Content-Type":"application/json","X-CSRFToken": getCookie("csrftoken") || ""},
      body: JSON.stringify({ diagram_id, cpps_id, permission_actors: extra })
    });
    const json = await r.json().catch(()=> ({}));
    const holder = document.getElementById("alertHolder");
    if(!r.ok){ holder.innerHTML = alertHtml('danger', json.detail || 'Saving error'); return; }
    holder.innerHTML = alertHtml('success', 'Permissions updated.');
  });
</script>
<!-- Bootstrap Icons (per il trash) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</body>
</html>
