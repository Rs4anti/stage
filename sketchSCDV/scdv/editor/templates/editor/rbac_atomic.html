{% load static %}
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>RBAC Policies · Atomic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h4 class="mb-0">Atomic Policies</h4>
    <div class="d-flex gap-2">
      <a href="{% url 'rbac_policies' %}?id={{ request.GET.id }}" class="btn btn-outline-secondary btn-sm">Back</a>
    </div>
  </div>

  <!-- Filtri rapidi (opzionali) -->
  <div class="card mb-3">
  <div class="card-body py-2">
    <form class="row g-2 align-items-end" id="filtersForm">
      <div class="col-12 col-md-6 col-lg-4">
        <label class="form-label form-label-sm">Filter by Owner</label>
        <input id="fOwner" class="form-control form-control-sm" placeholder="es. Production Leader">
      </div>
      <div class="col-12 col-md-6 col-lg-8 text-end">
        <button class="btn btn-primary btn-sm" id="applyFilters" type="submit">Apply</button>
        <button class="btn btn-outline-secondary btn-sm" id="clearFilters" type="button">Reset</button>
      </div>
    </form>
  </div>
</div>


  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th style="width: 18%">Atomic Name</th>
              <th style="width: 10%">Type</th>
              <th style="width: 20%">Owner</th>
              <th>Permissions (actor → perm)</th>
              <th style="width: 10%"></th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="5" class="text-center py-4" id="loadingRow">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
  const API_URL = "{% url 'rbac_atomic_by_diagram' %}";

  function esc(s){ return (s ?? '').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function badgePerm(p){ return `<span class="badge ${p==='invoke'?'bg-success':'bg-secondary'}">${esc(p)}</span>`; }

  function buildEditUrl(atomicId, diagramId){
    const base = "{% url 'rbac_atomic_edit' 'ATOMIC_PLACEHOLDER' %}".replace("ATOMIC_PLACEHOLDER", encodeURIComponent(atomicId));
    return `${base}?id=${encodeURIComponent(diagramId)}`;
  }

  function rowHtml(p, diagramId){
    // name: usa service_name se presente, altrimenti fallback su atomic_id
    const name =
      (typeof p.service_name === "string" && p.service_name.trim().length)
        ? p.service_name
        : p.atomic_id;

    // permissions: assicurati sia un array
    const permsArr = Array.isArray(p.permissions) ? p.permissions : [];
    const perms = permsArr.length
      ? permsArr.map(x => `${esc(x.actor)} → ${badgePerm(x.permission)}`).join("<br>")
      : '<span class="text-muted">—</span>';

    return `<tr>
      <td><code>${esc(name)}</code></td>
      <td><span class="badge bg-info-subtle text-info">${esc(p.atomic_type || '')}</span></td>
      <td>${esc(p.owner || '')}</td>
      <td>${perms}</td>
      <td class="text-end">
        <a class="btn btn-sm btn-outline-primary" href="${buildEditUrl(p.atomic_id, diagramId)}">Edit</a>
      </td>
    </tr>`;
  }

  async function fetchAtomic(diagramId, {owner} = {}){
    const qs = new URLSearchParams({ id: diagramId });
    const res = await fetch(`${API_URL}?${qs.toString()}`);
    if(!res.ok){
      const txt = await res.text();
      throw new Error(`API error (status ${res.status}): ${txt}`);
    }
    let data = await res.json();
    let results = data.results || [];

    // filtro lato client per Owner
    if (owner) {
      const term = owner.toLowerCase();
      results = results.filter(p => (p.owner || '').toLowerCase().includes(term));
    }
    return results;
  }

  async function load(){
    const params = new URLSearchParams(window.location.search);
    const diagramId = params.get("id");
    const tbody = document.getElementById("tbody");
    const loadingRow = document.getElementById("loadingRow");

    if (!diagramId){
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">diagram_id mancante nell'URL</td></tr>`;
      return;
    }

    try {
      const owner = document.getElementById("fOwner").value.trim();
      const results = await fetchAtomic(diagramId, { owner });
      if (!results.length){
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">Nessun documento trovato</td></tr>`;
        return;
      }
      tbody.innerHTML = results.map(p => rowHtml(p, diagramId)).join("");
    } catch (e){
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">Errore nel caricamento: ${esc(e.message)}</td></tr>`;
    } finally {
      if (loadingRow) loadingRow.remove();
    }
  }

  document.getElementById("filtersForm").addEventListener("submit", (e)=>{ e.preventDefault(); load(); });
  document.getElementById("clearFilters").addEventListener("click", ()=>{
    document.getElementById("fOwner").value = "";
    load();
  });

  load();
</script>

<script>
  function buildEditUrl(atomicId, diagramId){
    const base = "{% url 'rbac_atomic_edit' 'ATOMIC_ID' %}"
                   .replace("ATOMIC_ID", encodeURIComponent(atomicId));
    // passo il diagram id come querystring (?id=...)
    return `${base}?id=${encodeURIComponent(diagramId)}`;
  }
</script>


</body>
</html>
