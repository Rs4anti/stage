{% extends "base.html" %}

{% block title %}Elenco Diagrammi - Supply Chain Viewer{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4 text-center">üìö Elenco dei Supply Chain Data View</h2>

  <table class="table table-striped table-bordered">
    <thead class="table-light">
      <tr>
        <th>Nome</th>
        <th class="text-center">Azioni</th>
      </tr>
    </thead>
    <tbody id="diagram-table-body">
      <!-- Popolato da JavaScript -->
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadDiagramList() {
  const res = await fetch('/viewer/api/list/');
  const list = await res.json();
  const tbody = document.getElementById('diagram-table-body');
  tbody.innerHTML = '';

  list.forEach(d => {
  const row = document.createElement('tr');
  const viewUrl = `/viewer/by-name/${encodeURIComponent(d.name)}/`;

row.innerHTML = `
  <td>${d.name}</td>
  <td class="text-center">
    <a href="${viewUrl}" class="btn btn-sm btn-info me-2">Vedi</a>
    <button class="btn btn-sm btn-warning me-2" onclick="editDiagram('${d.id}')">Modifica</button>
      <button class="btn btn-sm btn-secondary" onclick="exportDiagram('${d.id}')">Export</button>
  </td>
`;

  tbody.appendChild(row);
});

}

async function viewDiagram(id) {
  const res = await fetch(`/viewer/api/${id}/`);
  const data = await res.json();
  await openDiagram(data.xml_content);
  alert(`üü¶ Visualizzazione: ${data.name}`);
}

async function editDiagram(id) {
  const res = await fetch(`/viewer/api/${id}/`);
  const data = await res.json();
  await openDiagram(data.xml_content);
  localStorage.setItem('diagramId', data.id);
  window.diagramId = data.id;
  alert(`‚úèÔ∏è Modifica: ${data.name}`);
  // eventualmente redirect a /editor/
  // window.location.href = '/editor/';
}

async function exportDiagram(id) {
  const res = await fetch(`/viewer/api/${id}/`);
  const data = await res.json();
  const blob = new Blob([data.xml_content], { type: 'text/xml' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${data.name || 'diagram'}.bpmn`;
  a.click();
  URL.revokeObjectURL(url);
}

document.addEventListener('DOMContentLoaded', loadDiagramList);
</script>
{% endblock %}
